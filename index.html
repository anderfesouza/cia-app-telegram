<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CIA - Search Engine</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg-gradient: linear-gradient(180deg, #0a0a0a 0%, #1a0b2e 100%);
            --input-bg: #1c1c1e;
            --primary-gradient: linear-gradient(90deg, #FF007F 0%, #bd00ff 100%);
            --text-main: #FFFFFF;
            --text-sec: #8E8E93;
            --border-color: rgba(255, 255, 255, 0.15);
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- TOPO FIXO --- */
        .top-fixed-area {
            background: rgba(10, 10, 10, 0.98);
            padding: 15px 20px 20px 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 100;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .brand {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #BB86FC;
        }

        .logout-btn {
            background: none; border: none; color: var(--text-sec);
            font-size: 12px; cursor: pointer; text-decoration: underline;
        }

        /* --- NOVA BARRA DE PESQUISA (FLEXBOX) --- */
        /* A caixa cinza agora √© um container que segura tudo */
        .search-wrapper {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            display: flex;
            align-items: flex-end; /* Alinha itens na base */
            padding: 8px;
            transition: border-color 0.3s;
            min-height: 54px;
            box-sizing: border-box;
        }

        .search-wrapper:focus-within {
            border-color: #bd00ff;
        }

        /* O Input de texto agora ocupa o espa√ßo restante */
        .search-box {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            width: 100%;
            flex: 1; /* Ocupa todo espa√ßo dispon√≠vel */
            outline: none;
            resize: none;
            overflow: hidden;
            max-height: 120px;
            font-family: inherit;
            line-height: 1.4;
            padding: 10px 5px 10px 10px; /* Espa√ßo interno do texto */
            margin-bottom: 2px; /* Ajuste fino alinhamento */
        }

        /* Container dos √≠cones (Lado direito fixo) */
        .action-buttons {
            display: flex;
            align-items: center;
            gap: 4px;
            padding-bottom: 4px; /* Alinha com o texto */
            flex-shrink: 0; /* N√£o encolhe */
        }

        .icon-btn {
            padding: 8px;
            border-radius: 50%;
            color: var(--text-sec);
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            transition: 0.2s;
        }
        .icon-btn svg { fill: currentColor; }
        .icon-btn.active { color: #FF007F; background: rgba(255, 0, 127, 0.1); }
        .icon-btn.recording { color: #FF0000; animation: pulse 1.5s infinite; }

        .send-btn {
            background: var(--primary-gradient);
            border: none;
            border-radius: 16px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            margin-left: 4px;
        }

        /* --- CONTE√öDO --- */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        #tips-placeholder {
            text-align: center;
            color: var(--text-sec);
            margin-top: 40px;
        }
        .tip-highlight { color: #BB86FC; }

        .chat-bubble {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 15px;
            color: #E0E0E0;
            white-space: pre-wrap;
            display: none;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .chat-bubble strong { color: #FF007F; font-weight: 700; }

        #attachment-indicator {
            display: none;
            font-size: 12px;
            color: #00E676;
            margin-top: 8px;
            padding-left: 5px;
            font-weight: 500;
        }

        /* Login Screen */
        #login-screen { display: none; padding: 40px 20px; text-align: center; }
        .login-input { 
            background: var(--input-bg); border: 1px solid var(--border-color);
            padding: 15px; border-radius: 12px; color: white; width: 100%; 
            box-sizing: border-box; margin-bottom: 15px; font-size: 16px;
        }
        
        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="margin-bottom: 20px;">Acesso VIP</h2>
        <input type="email" id="user-email" class="login-input" placeholder="Seu e-mail de compra">
        <button onclick="validateUser()" class="send-btn" style="width:100%; height: 50px; font-weight: bold; border-radius: 12px;">ENTRAR</button>
        <p id="login-msg" style="margin-top: 15px; font-size: 14px; color: #FF007F;"></p>
    </div>

    <div id="app-screen" class="hidden">
        
        <div class="top-fixed-area">
            <div class="header-row">
                <div class="brand">CIA ‚Ä¢ Dr. Renan Botelho</div>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>

            <div class="search-wrapper">
                <textarea 
                    id="search-input" 
                    class="search-box" 
                    rows="1" 
                    placeholder="Pergunte ou envie foto..." 
                    oninput="autoResize(this)"
                    onkeydown="checkEnter(event)"
                ></textarea>
                
                <div class="action-buttons">
                    <button class="icon-btn" onclick="triggerFile()" id="cam-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5l3.5 3.5-3.5 3.5z"/><path d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="3.2"/></svg>
                    </button>
                    <input type="file" id="file-upload" accept="image/*" onchange="fileSelected(this)" class="hidden">

                    <button class="icon-btn" id="mic-btn" onclick="toggleAudio()">
                        <svg viewBox="0 0 24 24" width="24" height="24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.66 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
                    </button>

                    <button class="send-btn" onclick="sendData()">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
            
            <div id="attachment-indicator">üì∑ Imagem anexada</div>
        </div>

        <div class="content-area">
            <div id="tips-placeholder">
                <div style="margin-bottom: 20px; opacity: 0.5;">
                    <svg viewBox="0 0 24 24" width="48" height="48" fill="white"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                </div>
                <div style="font-weight: 600; margin-bottom: 10px;">Dica para an√°lise perfeita</div>
                <p style="font-size: 14px; line-height: 1.6; color: #8E8E93; max-width: 300px; margin: 0 auto;">
                    Se for foto: <span class="tip-highlight">Boa luz e sem reflexo.</span><br>
                    Aproxime para ler os INGREDIENTES.
                </p>
            </div>
            <div id="result-content" class="chat-bubble"></div>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const WEBHOOK = 'https://rbo3wh.anderfesouza.com.br/webhook/alunablack';

    let currentImageBase64 = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener("DOMContentLoaded", () => {
        const email = localStorage.getItem('cia_user_email');
        if (email) {
            document.getElementById('user-email').value = email;
            showScreen('app');
        } else {
            showScreen('login');
        }
    });

    // Auto-Resize Textarea
    function autoResize(textarea) {
        textarea.style.height = 'auto'; 
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    // ENTER para enviar (Corre√ß√£o solicitada)
    function checkEnter(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Evita pular linha
            sendData();
        }
    }

    // Foco e Trigger de Arquivo
    function triggerFile() {
        document.getElementById('file-upload').click();
    }

    function fileSelected(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                currentImageBase64 = e.target.result;
                
                // UX Feedback
                document.getElementById('cam-btn').classList.add('active');
                document.getElementById('attachment-indicator').style.display = 'block';
                const inputBox = document.getElementById('search-input');
                inputBox.placeholder = "Adicione uma pergunta √† foto...";
                
                input.value = ''; 
                
                // CORRE√á√ÉO: Devolve o foco para digitar
                inputBox.focus();
            };
            reader.readAsDataURL(file);
        }
    }

    // Audio Logic
    async function toggleAudio() {
        const btn = document.getElementById('mic-btn');
        const inputBox = document.getElementById('search-input');

        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.start();
                isRecording = true;
                btn.classList.add('recording');
                inputBox.placeholder = "Gravando... (Toque para parar)";
            } catch (err) { alert("Permiss√£o de microfone negada."); }
        } else {
            mediaRecorder.stop();
            isRecording = false;
            btn.classList.remove('recording');
            inputBox.placeholder = "Enviando √°udio...";
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = async () => {
                    sendToBackend({ type: 'audio', content: reader.result });
                    // CORRE√á√ÉO: Foco volta ao input
                    inputBox.placeholder = "Pergunte ou envie foto...";
                    inputBox.focus();
                };
            };
        }
    }

    // Enviar Dados
    async function sendData() {
        const textField = document.getElementById('search-input');
        const text = textField.value;
        
        if (!currentImageBase64 && text.trim() === "") return; // N√£o envia vazio

        const payload = currentImageBase64 
            ? { type: 'image', content: currentImageBase64, caption: text }
            : { type: 'text', content: text };
            
        sendToBackend(payload);
    }

    async function sendToBackend(payload) {
        // UI Reset
        document.getElementById('tips-placeholder').style.display = 'none';
        const resultDiv = document.getElementById('result-content');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="text-align:center; opacity:0.7;">Analisando...</div>';
        
        const textField = document.getElementById('search-input');
        textField.value = "";
        textField.style.height = 'auto'; // Reset altura
        
        document.getElementById('attachment-indicator').style.display = 'none';
        document.getElementById('cam-btn').classList.remove('active');
        currentImageBase64 = null; 
        
        // Mant√©m foco para continuar conversando
        textField.focus();

        try {
            const user = tg.initDataUnsafe.user || { id: 'web_test' };
            const email = localStorage.getItem('cia_user_email');

            const body = {
                action: 'consult_ai',
                telegram_id: user.id,
                email: email,
                type: payload.type,
                data: payload.content,
                caption: payload.caption || ""
            };

            const response = await fetch(WEBHOOK, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            
            let formatted = (data.ai_response || "Sem resposta.")
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            resultDiv.innerHTML = formatted;

        } catch (e) {
            resultDiv.innerHTML = "Erro de conex√£o.";
        }
    }

    // Login/Logout
    async function validateUser() {
        const email = document.getElementById('user-email').value;
        const btn = document.querySelector('#login-screen .send-btn');
        if(!email.includes('@')) return;

        btn.innerText = "...";
        try {
            const user = tg.initDataUnsafe.user || { id: 'test' };
            const res = await fetch(WEBHOOK, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'validate_user', email: email, telegram_id: user.id })
            });
            const data = await res.json();
            
            if(data.active) {
                localStorage.setItem('cia_user_email', email);
                showScreen('app');
            } else {
                document.getElementById('login-msg').innerText = "Acesso n√£o encontrado.";
            }
        } catch(e) { alert("Erro de conex√£o"); }
        btn.innerText = "ENTRAR";
    }

    function logout() {
        localStorage.removeItem('cia_user_email');
        location.reload();
    }

    function showScreen(screen) {
        document.getElementById('login-screen').style.display = screen === 'login' ? 'block' : 'none';
        const app = document.getElementById('app-screen');
        if(screen === 'app') app.classList.remove('hidden');
        else app.classList.add('hidden');
    }
</script>
</body>
</html>
