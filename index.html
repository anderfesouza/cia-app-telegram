<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CIA - Search Engine</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- DESIGN SYSTEM PREMIUM --- */
        :root {
            --bg-gradient: linear-gradient(180deg, #0a0a0a 0%, #1a0b2e 100%);
            --input-bg: #1c1c1e;
            --primary-gradient: linear-gradient(90deg, #FF007F 0%, #bd00ff 100%);
            --text-main: #FFFFFF;
            --text-sec: #8E8E93;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Evita scroll na p√°gina inteira */
        }

        /* --- TOPO FIXO (Header + Input) --- */
        .top-fixed-area {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px 20px 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 100;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .brand {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #BB86FC;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-sec);
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
        }

        /* --- BARRA DE PESQUISA UNIFICADA --- */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-box {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 100px 12px 15px; /* Espa√ßo na direita para √≠cones */
            color: white;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s;
        }
        .search-box:focus { border-color: #bd00ff; }

        /* √çcones dentro da barra (Direita) */
        .input-icons {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-sec);
            transition: 0.2s;
        }
        .icon-btn svg { width: 22px; height: 22px; fill: currentColor; }
        
        .icon-btn.active { color: #FF007F; background: rgba(255, 0, 127, 0.1); }
        .icon-btn.recording { color: #FF0000; animation: pulse 1.5s infinite; }

        .send-btn {
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
        }

        /* --- √ÅREA DE CONTE√öDO (Scroll√°vel) --- */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        /* Dicas (Estado Vazio) */
        #tips-placeholder {
            text-align: center;
            color: var(--text-sec);
            margin-top: 40px;
            animation: fadeIn 0.5s ease;
        }
        .tip-title { color: #fff; font-size: 16px; margin-bottom: 10px; font-weight: 600; }
        .tip-text { font-size: 14px; line-height: 1.6; max-width: 300px; margin: 0 auto; }
        .tip-highlight { color: #BB86FC; }

        /* Resultado (Chat) */
        .chat-bubble {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 15px;
            color: #E0E0E0;
            white-space: pre-wrap;
            display: none; /* Escondido at√© ter resposta */
        }
        .chat-bubble strong { color: #FF007F; }

        /* Indicador de arquivo anexado */
        #attachment-indicator {
            display: none;
            font-size: 12px;
            color: #00E676;
            margin-top: 5px;
            padding-left: 5px;
        }

        /* Login Screen (Simples) */
        #login-screen { display: none; padding: 40px 20px; text-align: center; }
        #app-screen { display: flex; flex-direction: column; height: 100%; }
        
        /* Utils */
        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="margin-bottom: 20px;">Acesso VIP</h2>
        <input type="email" id="user-email" class="search-box" placeholder="Seu e-mail de compra" style="margin-bottom: 15px;">
        <button onclick="validateUser()" class="send-btn" style="width:100%; height: 50px; font-weight: bold;">ENTRAR</button>
        <p id="login-msg" style="margin-top: 15px; font-size: 14px; color: #FF007F;"></p>
    </div>

    <div id="app-screen" class="hidden">
        
        <div class="top-fixed-area">
            <div class="header-row">
                <div class="brand">CIA ‚Ä¢ Dr. Renan Botelho</div>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>

            <div class="search-container">
                <input type="text" id="search-input" class="search-box" placeholder="Pergunte ou envie foto...">
                
                <div class="input-icons">
                    <button class="icon-btn" onclick="document.getElementById('file-upload').click()" id="cam-btn">
                        <svg viewBox="0 0 24 24"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5l3.5 3.5-3.5 3.5z"/><path d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="3.2"/></svg>
                    </button>
                    <input type="file" id="file-upload" accept="image/*" onchange="fileSelected(this)" class="hidden">

                    <button class="icon-btn" id="mic-btn" onclick="toggleAudio()">
                        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.66 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
                    </button>

                    <button class="send-btn" onclick="sendData()">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
            <div id="attachment-indicator">üì∑ Imagem anexada</div>
        </div>

        <div class="content-area">
            
            <div id="tips-placeholder">
                <div style="margin-bottom: 20px; opacity: 0.5;">
                    <svg viewBox="0 0 24 24" width="48" height="48" fill="white"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                </div>
                <div class="tip-title">Dica para an√°lise perfeita</div>
                <p class="tip-text">
                    Envie sua mensagem ou uma foto.<br><br>
                    Se for foto: <span class="tip-highlight">Boa luz. Sem reflexo.</span><br>
                    Aproxime para que a lista de <span class="tip-highlight">INGREDIENTES</span> fique bem leg√≠vel.
                </p>
            </div>

            <div id="result-content" class="chat-bubble"></div>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const WEBHOOK = 'https://rbo3wh.anderfesouza.com.br/webhook/alunablack';

    // Estado local
    let currentImageBase64 = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener("DOMContentLoaded", () => {
        const email = localStorage.getItem('cia_user_email');
        if (email) {
            document.getElementById('user-email').value = email;
            showScreen('app');
        } else {
            showScreen('login');
        }
    });

    function showScreen(screen) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').classList.add('hidden');
        
        if(screen === 'login') document.getElementById('login-screen').style.display = 'block';
        else document.getElementById('app-screen').classList.remove('hidden');
    }

    // --- L√ìGICA DE ARQUIVOS (FOTO) ---
    function fileSelected(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                currentImageBase64 = e.target.result; // Salva o base64
                // Visual Update
                document.getElementById('cam-btn').classList.add('active');
                document.getElementById('attachment-indicator').style.display = 'block';
                document.getElementById('search-input').placeholder = "Adicione uma pergunta √† foto...";
            };
            reader.readAsDataURL(file);
        }
    }

    // --- L√ìGICA DE √ÅUDIO ---
    async function toggleAudio() {
        const btn = document.getElementById('mic-btn');

        if (!isRecording) {
            // Iniciar Grava√ß√£o
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                
                mediaRecorder.start();
                isRecording = true;
                btn.classList.add('recording');
                document.getElementById('search-input').placeholder = "Gravando √°udio... Clique para parar.";
            } catch (err) {
                alert("Permiss√£o de microfone necess√°ria.");
            }
        } else {
            // Parar e Enviar
            mediaRecorder.stop();
            isRecording = false;
            btn.classList.remove('recording');
            document.getElementById('search-input').placeholder = "Processando √°udio...";
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                // Converter Blob para Base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = async () => {
                    const base64Audio = reader.result;
                    // Envia como tipo √Åudio
                    sendToBackend({ type: 'audio', content: base64Audio });
                };
            };
        }
    }

    // --- L√ìGICA DE ENVIO PRINCIPAL ---
    async function sendData() {
        const text = document.getElementById('search-input').value;
        
        // Cen√°rio 1: Tem Foto (com ou sem texto)
        if (currentImageBase64) {
            sendToBackend({ 
                type: 'image', 
                content: currentImageBase64, 
                caption: text // Texto vai como legenda
            });
            return;
        }

        // Cen√°rio 2: Texto Puro
        if (text.trim() !== "") {
            sendToBackend({ 
                type: 'text', 
                content: text 
            });
            return;
        }
    }

    async function sendToBackend(payload) {
        // UI Feedback
        document.getElementById('tips-placeholder').style.display = 'none';
        const resultDiv = document.getElementById('result-content');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="text-align:center; opacity:0.7;">Um momento...</div>';
        
        // Limpar inputs
        document.getElementById('search-input').value = "";
        document.getElementById('attachment-indicator').style.display = 'none';
        document.getElementById('cam-btn').classList.remove('active');
        currentImageBase64 = null; // Reset imagem

        try {
            const user = tg.initDataUnsafe.user || { id: 'web_test' };
            const email = localStorage.getItem('cia_user_email');

            // Monta o JSON final pro n8n
            const body = {
                action: 'consult_ai',
                telegram_id: user.id,
                email: email,
                type: payload.type, // 'text', 'image', 'audio'
                data: payload.content, // O conte√∫do principal (texto ou base64)
                caption: payload.caption || "" // Legenda da foto se houver
            };

            const response = await fetch(WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            
            // Formata Resposta
            let formatted = (data.ai_response || "Sem resposta.")
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            resultDiv.innerHTML = formatted;

        } catch (e) {
            resultDiv.innerHTML = "Erro ao conectar. Tente novamente.";
        }
    }

    // --- LOGIN / LOGOUT ---
    async function validateUser() {
        const email = document.getElementById('user-email').value;
        const btn = document.querySelector('#login-screen .send-btn');
        if(!email.includes('@')) return;

        btn.innerText = "...";
        try {
            const user = tg.initDataUnsafe.user || { id: 'test' };
            const res = await fetch(WEBHOOK, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'validate_user', email: email, telegram_id: user.id })
            });
            const data = await res.json();
            
            if(data.active) {
                localStorage.setItem('cia_user_email', email);
                showScreen('app');
            } else {
                document.getElementById('login-msg').innerText = "Acesso n√£o encontrado.";
            }
        } catch(e) {
            alert("Erro de conex√£o");
        }
        btn.innerText = "ENTRAR";
    }

    function logout() {
        localStorage.removeItem('cia_user_email');
        location.reload();
    }
</script>
</body>
</html>
